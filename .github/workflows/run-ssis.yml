name: Ejecutar Paquete SSIS

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Nombre del paquete a ejecutar (sin extensión opcional)'
        required: false
        default: 'General'
  schedule:
    - cron: '0 2 * * *'  # 2:00 AM UTC todos los días

jobs:
  run-dtsx:
    runs-on: windows-latest

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v3

    - name: Ejecutar paquete SSIS
      shell: powershell
      run: |
        # Obtener el nombre del paquete
        $package = "${{ github.event.inputs.package_name }}"
        if (-not $package) { $package = "General" }

        # Agregar la extensión .dtsx si no está
        if (-not $package.ToLower().EndsWith(".dtsx")) { $package += ".dtsx" }

        Write-Host "Ejecutando paquete: $package"

        # Ruta dentro del repo clonado
        $packagePath = Join-Path $PWD "SIDCOP_ETL\SIDCOP_Backend.ETL\$package"

        # Definir archivo de log
        $logFile = Join-Path $PWD "dtsx-log.txt"

        # Ejecutar paquete y guardar salida en log
        dtexec /F "$packagePath" > $logFile 2>&1
        $exitCode = $LASTEXITCODE

        # Mostrar log completo en consola
        Get-Content $logFile | ForEach-Object { Write-Host $_ }

        if ($exitCode -eq 0) {
            Write-Host "✅ DTSX ejecutado correctamente."
        } else {
            Write-Error "❌ DTSX falló con código $exitCode."
            exit $exitCode
        }

    - name: Subir log como artifact
      uses: actions/upload-artifact@v4
      with:
        name: dtsx-log
        path: dtsx-log.txt
